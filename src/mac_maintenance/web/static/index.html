<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="app-version" content="3.0.2">
    <link rel="icon" type="image/svg+xml" href="/favicon.ico">
    <title>Mac Maintenance</title>
    <style>
        :root {
            /* Light theme (default) */
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f9f9f9;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --border-color: #d2d2d7;
            --border-light: #e5e5e7;
            --accent-color: #007aff;
            --accent-hover: #0051d5;
            --danger-color: #ff3b30;
            --danger-hover: #cc0000;
            --warning-bg: #fff3cd;
            --warning-color: #856404;
            --error-bg: #ffe5e5;
            --error-color: #cc0000;
            --success-bg: #e5ffe5;
            --success-color: #00aa00;
            --shadow: rgba(0,0,0,0.1);
            --terminal-bg: #1d1d1f;
            --terminal-text: #00ff00;
        }

        [data-theme="dark"] {
            /* Dark theme */
            --bg-primary: #1c1c1e;
            --bg-secondary: #2c2c2e;
            --bg-tertiary: #3a3a3c;
            --text-primary: #f5f5f7;
            --text-secondary: #98989d;
            --border-color: #48484a;
            --border-light: #3a3a3c;
            --accent-color: #0a84ff;
            --accent-hover: #409cff;
            --danger-color: #ff453a;
            --danger-hover: #ff6961;
            --warning-bg: #3a3a1c;
            --warning-color: #ffd60a;
            --error-bg: #3a1c1c;
            --error-color: #ff6961;
            --success-bg: #1c3a1c;
            --success-color: #32d74b;
            --shadow: rgba(0,0,0,0.3);
            --terminal-bg: #000000;
            --terminal-text: #00ff00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        nav {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        nav h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--border-light);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
        }

        .tabs button {
            padding: 0.5rem 1.5rem;
            border: none;
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .tabs button:hover {
            background: var(--border-light);
        }

        .tabs button.active {
            background: var(--accent-color);
            color: white;
        }

        main {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 1.5rem;
        }

        .card h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .metric-card {
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }

        .metric-card h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-card .subvalue {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-light);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
            display: block !important;
            visibility: visible !important;
            position: relative;
            z-index: 1;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s;
            display: block !important;
            visibility: visible !important;
            min-width: 2px;  /* Ensure bar is always visible even at 0% */
        }

        .progress-bar-fill.warning { background: #ff9500; }
        .progress-bar-fill.danger { background: var(--danger-color); }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .info-item {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .info-item dt {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .info-item dd {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .form-group {
            margin: 1rem 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        button.primary {
            padding: 0.75rem 1rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            cursor: pointer;
            transition: all 0.2s;
            width: 240px;
            height: 44px;
            text-align: center;
        }

        button.primary:hover {
            background: var(--accent-hover);
        }

        button.primary:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        button.danger {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.75rem 1rem;
            width: 240px;
            height: 44px;
            text-align: center;
        }

        button.danger:hover {
            background: var(--danger-hover);
        }

        button.danger:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.6;
        }

        button.success-flash {
            background: #34c759 !important;
            animation: successPulse 0.3s ease-in-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        button.warning {
            background: #ff9500;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.75rem 1rem;
            width: 240px;
            height: 44px;
            text-align: center;
        }

        button.warning:hover {
            background: #cc7700;
        }

        button.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.75rem 2rem;
        }

        button.secondary:hover {
            background: var(--border-light);
        }

        /* Storage deletion buttons: emphasize safety */
        #trash-btn {
            /* Primary = safe, recoverable option */
            box-shadow: 0 2px 4px var(--shadow);
        }

        #trash-btn:hover {
            box-shadow: 0 4px 8px var(--shadow);
            transform: translateY(-1px);
        }

        #permanent-delete-btn {
            /* Danger = permanent, cannot be undone */
            position: relative;
        }

        #permanent-delete-btn:hover {
            background: var(--danger-hover);
            box-shadow: 0 0 8px rgba(255, 59, 48, 0.3);
        }

        #permanent-delete-btn:disabled,
        #trash-btn:disabled {
            transform: none;
            box-shadow: none;
        }

        .file-list {
            margin-top: 1rem;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            overflow: hidden;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.2s;
        }

        .file-item:hover {
            background: var(--bg-tertiary);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item input[type="checkbox"] {
            margin-right: 1rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .file-info {
            flex: 1;
        }

        .file-size {
            text-align: right;
            min-width: 120px;
        }

        .operation-list {
            margin-top: 1rem;
        }

        .operation-item {
            padding: 1rem;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            background: var(--bg-secondary);
        }

        .operation-item:hover {
            background: var(--bg-tertiary);
        }

        .operation-item input[type="checkbox"] {
            margin-right: 1rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .operation-info {
            flex: 1;
        }

        .operation-info h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .operation-info p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Operation details accordion */
        .operation-details {
            margin-top: 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .operation-details summary {
            padding: 0.75rem 1rem;
            cursor: pointer;
            user-select: none;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--primary-color);
            background: var(--bg-tertiary);
            transition: background 0.2s;
            display: flex;
            align-items: center;
            position: relative;
        }

        .operation-details summary:hover {
            background: var(--border-light);
        }

        .operation-details summary:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }

        /* Chevron icon for accordion */
        .operation-details summary::after {
            content: '‚ñº';
            position: absolute;
            right: 1rem;
            font-size: 0.7rem;
            transition: transform 0.2s;
            color: var(--text-secondary);
        }

        .operation-details[open] summary::after {
            transform: rotate(-180deg);
        }

        /* Hide default disclosure triangle */
        .operation-details summary::-webkit-details-marker {
            display: none;
        }

        .operation-details-content {
            padding: 1rem;
            font-size: 0.85rem;
            line-height: 1.6;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .operation-context {
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-left: 3px solid var(--primary-color);
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .operation-when, .operation-why, .operation-what {
            margin-bottom: 1.25rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .operation-when h5, .operation-why h5, .operation-what h5 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .operation-when ul, .operation-why ul, .operation-what ul {
            margin: 0;
            padding-left: 0;
            list-style: none;
        }

        .operation-when li, .operation-why li, .operation-what li {
            margin-bottom: 0.75rem;
            position: relative;
            padding-left: 1.5rem;
            line-height: 1.5;
        }

        .operation-when li:before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-weight: bold;
        }

        .operation-why li strong {
            color: var(--error-color);
            display: block;
            margin-bottom: 0.25rem;
        }

        .operation-timeline {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 0.75rem;
            color: var(--text-secondary);
        }

        .operation-timeline strong {
            color: var(--text-primary);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .error {
            padding: 1rem;
            background: var(--error-bg);
            color: var(--error-color);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .success {
            padding: 1rem;
            background: var(--success-bg);
            color: var(--success-color);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .warning {
            padding: 1rem;
            background: var(--warning-bg);
            color: var(--warning-color);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .button-group button {
            flex: 0 0 auto;
            margin: 0;
            box-sizing: border-box;
        }

        /* Force Skip Current button to match other action buttons */
        #skip-btn {
            width: 240px !important;
            height: 44px !important;
            padding: 0.75rem 1rem !important;
            line-height: 1.5 !important;
            font-weight: 400 !important;
            font-size: 1rem !important;
            box-sizing: border-box !important;
            vertical-align: middle !important;
        }

        /* Ensure button is hidden by default */
        #skip-btn[style*="display:none"],
        #skip-btn[style*="display: none"] {
            display: none !important;
        }

        .progress-output {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--terminal-bg);
            color: var(--terminal-text);
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge.recommended {
            background: var(--accent-color);
            color: white;
        }

        .badge.optional {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast {
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent-color);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: var(--danger-color);
        }

        .toast.warning {
            border-left-color: #ff9500;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Quick path buttons */
        .quick-paths {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .quick-path-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .quick-path-btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        /* Search box */
        .search-box {
            margin-bottom: 1rem;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
        }

        /* Breadcrumbs */
        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .breadcrumb {
            cursor: pointer;
            transition: color 0.2s;
        }

        .breadcrumb:hover {
            color: var(--accent-color);
        }

        .breadcrumb-separator {
            color: var(--text-secondary);
        }

        /* Operation categories */
        .operation-category {
            margin-bottom: 1.5rem;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .category-header:hover {
            background: var(--border-light);
        }

        .category-header h3 {
            flex: 1;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .category-toggle {
            font-size: 1.2rem;
            transition: transform 0.2s;
        }

        .category-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .category-operations {
            margin-left: 1rem;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
        }

        .category-operations.collapsed {
            max-height: 0;
            opacity: 0;
        }

        /* Smooth transitions */
        button, .operation-item, .file-item, .metric-card {
            transition: all 0.2s ease-out;
        }

        button:active {
            transform: scale(0.98);
        }

        .operation-item:hover, .file-item:hover {
            transform: translateX(4px);
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-light);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Keyboard shortcuts hint */
        .kbd {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.75rem;
            box-shadow: 0 1px 2px var(--shadow);
        }

        /* Trend indicators */
        .trend {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }

        .trend.up {
            color: #ff6961;  /* Red for rising */
        }

        .trend.down {
            color: #32d74b;  /* Green for falling */
        }

        .trend.neutral {
            color: var(--text-secondary);
        }

        /* Sparkline container */
        .sparkline-container {
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }

        .sparkline {
            width: 80px;
            height: 24px;
            display: block;
        }

        /* Health score card */
        .health-score-card {
            text-align: center;
        }

        .health-score-value {
            font-size: 3rem;
            font-weight: 700;
            margin: 1rem 0;
        }

        .health-score-value.excellent { color: #32d74b; }
        .health-score-value.good { color: #0a84ff; }
        .health-score-value.fair { color: #ff9500; }
        .health-score-value.poor { color: #ff3b30; }

        .health-score-label {
            font-size: 1.1rem;
            font-weight: 500;
            text-transform: capitalize;
            margin-bottom: 1rem;
        }

        .health-breakdown {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .health-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .health-item-icon {
            font-size: 1.2rem;
        }

        .health-item-text {
            flex: 1;
            font-size: 0.875rem;
        }

        /* Progress overlay modal */
        .progress-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .progress-overlay.active {
            display: flex;
        }

        .progress-modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2.5rem;
            min-width: 400px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .progress-modal h3 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            text-align: center;
        }

        .progress-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .progress-stat {
            text-align: center;
        }

        .progress-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-color);
        }

        .progress-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 12px;
            background: var(--border-light);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-bar-fill-animated {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #0051d5);
            transition: width 0.3s ease-out;
            border-radius: 6px;
        }

        .progress-actions {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
        }

        /* Top processes list */
        .process-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .process-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .process-item:hover {
            background: var(--border-light);
            transform: translateX(2px);
        }

        .process-name {
            font-weight: 500;
        }

        .process-value {
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--accent-color);
        }

        /* Path input with browse */
        .path-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .path-input-group input {
            flex: 1;
        }

        .browse-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .browse-btn:hover {
            background: var(--border-light);
        }

        /* Confirmation dialog */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow);
            max-width: 500px;
            width: 90%;
            animation: modalIn 0.2s ease-out;
        }

        @keyframes modalIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .modal-body {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        /* Schedule-specific styles */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .template-card {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-secondary);
        }

        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .template-card.recommended {
            border-color: var(--warning);
            background: rgba(255, 204, 0, 0.05);
        }

        .template-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .template-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .template-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .template-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--warning);
            color: var(--bg-primary);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .schedule-card {
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
            transition: all 0.2s;
        }

        .schedule-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .schedule-card.disabled {
            opacity: 0.6;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .schedule-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .schedule-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .schedule-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .schedule-actions button {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 36px;
            /* Override fixed dimensions from .warning and .danger */
            width: auto !important;
            height: 36px !important;
        }

        .schedule-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .schedule-info-item {
            display: flex;
            flex-direction: column;
        }

        .schedule-info-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .schedule-info-value {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .schedule-status {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .schedule-status.enabled {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
        }

        .schedule-status.disabled {
            background: rgba(142, 142, 147, 0.1);
            color: var(--text-secondary);
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .day-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-secondary);
        }

        .day-checkbox input[type="checkbox"] {
            display: none;
        }

        .day-checkbox span {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .day-checkbox:hover {
            border-color: var(--primary);
        }

        .day-checkbox input[type="checkbox"]:checked + span {
            color: var(--primary);
        }

        .day-checkbox:has(input[type="checkbox"]:checked) {
            background: rgba(0, 122, 255, 0.1);
            border-color: var(--primary);
        }

        .operations-selector {
            display: grid;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
        }

        .operation-checkbox {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-secondary);
        }

        .operation-checkbox:hover {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.05);
        }

        .operation-checkbox input[type="checkbox"] {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .operation-checkbox-label {
            flex: 1;
        }

        .operation-checkbox-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .operation-checkbox-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .next-run-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .conflict-warning {
            padding: 0.75rem 1rem;
            background: rgba(255, 149, 0, 0.1);
            border-left: 3px solid var(--warning);
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        .conflict-warning-text {
            font-size: 0.875rem;
            color: var(--warning);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Enhanced focus indicators for accessibility */
        *:focus-visible {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible,
        a:focus-visible {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
            border-radius: 4px;
        }

        .operation-item:focus-within,
        .metric-card:focus-within,
        .wizard-option:focus-within {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        /* Skip link for keyboard navigation */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent-color);
            color: white;
            padding: 0.5rem 1rem;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 10000;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Wizard option hover effects */
        .wizard-option:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        /* Empty state styling */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            margin: 1rem 0 0.5rem 0;
            color: var(--text-primary);
        }

    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <nav>
        <h1>üîß Mac Maintenance</h1>
        <div class="nav-controls">
            <div class="tabs">
                <button onclick="showTab('dashboard')" class="active">Dashboard</button>
                <button onclick="showTab('storage')">Storage</button>
                <button onclick="showTab('maintenance')">Maintenance</button>
                <button onclick="showTab('schedule')">Schedule</button>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme (Light ‚Üí Dark ‚Üí System)">
                <span id="theme-icon">üåô</span>
            </button>
        </div>
    </nav>

    <!-- Toast notification container -->
    <div class="toast-container" id="toast-container"></div>

    <main id="main-content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="card">
                <h2>System Overview</h2>
                <div class="metric-grid" id="system-metrics">
                    <div class="loading">Loading system information...</div>
                </div>
            </div>

            <div class="card">
                <h2>System Information</h2>
                <div class="info-grid" id="system-info">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <div class="card">
                <h2>Maintenance Status</h2>
                <div id="maintenance-status">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <div class="card">
                <h2>System Health</h2>
                <div class="health-score-card" id="health-score">
                    <div class="loading">Calculating...</div>
                </div>
            </div>

            <div class="card">
                <h2>Top Resource Consumers</h2>
                <div id="top-processes">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Progress Overlay Modal -->
        <div class="progress-overlay" id="progress-overlay">
            <div class="progress-modal">
                <h3 id="progress-title">Processing...</h3>
                <div class="progress-stats">
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="progress-percent">0%</div>
                        <div class="progress-stat-label">Complete</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="progress-current">0</div>
                        <div class="progress-stat-label">Processed</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="progress-remaining">--</div>
                        <div class="progress-stat-label">Time Remaining</div>
                    </div>
                </div>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-fill-animated" id="progress-bar" style="width: 0%"></div>
                </div>
                <div id="progress-message" style="text-align: center; color: var(--text-secondary); margin-top: 1rem;"></div>
                <div class="progress-actions">
                    <button class="danger" onclick="cancelProgress()" id="progress-cancel-btn">
                        Cancel Operation
                    </button>
                </div>
            </div>
        </div>

        <!-- Storage Tab -->
        <div id="storage" class="tab-content">
            <div class="card">
                <h2>Storage Analysis</h2>
                <div class="form-group">
                    <label for="path-input">
                        Path to Analyze:
                        <span class="kbd" style="margin-left: 0.5rem;">‚åò+L</span> to focus
                    </label>
                    <div class="quick-paths">
                        <button class="quick-path-btn" onclick="setPath('/Users')">üë§ Users</button>
                        <button class="quick-path-btn" onclick="setPath('/Users/' + getUsername())">üè† Home</button>
                        <button class="quick-path-btn" onclick="setPath('/Users/' + getUsername() + '/Downloads')">‚¨áÔ∏è Downloads</button>
                        <button class="quick-path-btn" onclick="setPath('/Users/' + getUsername() + '/Documents')">üìÑ Documents</button>
                        <button class="quick-path-btn" onclick="setPath('/Users/' + getUsername() + '/Desktop')">üñ•Ô∏è Desktop</button>
                        <button class="quick-path-btn" onclick="setPath('/Applications')">üì¶ Applications</button>
                        <button class="quick-path-btn" onclick="setPath('/Library')">üìö Library</button>
                    </div>
                    <div class="path-input-group">
                        <input type="text" id="path-input" placeholder="/Users/username/Downloads"
                               value="/Users">
                    </div>
                </div>
                <div id="breadcrumbs" class="breadcrumbs"></div>
                <button class="primary" onclick="analyzeStorage()">
                    <span id="analyze-btn-text">Analyze</span>
                </button>
                <div id="storage-results"></div>
            </div>
        </div>

        <!-- Maintenance Tab -->
        <div id="maintenance" class="tab-content">
            <div class="card">
                <h2>Maintenance Operations</h2>
                <p style="color: #6e6e73; margin-bottom: 1.5rem;">
                    Select operations to run. Recommended operations are pre-selected.
                    <span class="kbd">‚åò+Enter</span> to run selected
                </p>
                <div class="search-box">
                    <input type="text" id="operation-search" placeholder="Search operations..."
                           oninput="filterOperations()" onkeyup="handleSearchKey(event)">
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions" style="margin: 1.5rem 0; padding: 1rem; background: linear-gradient(135deg, var(--accent-color) 0%, #0051d5 100%); border-radius: 12px; display: flex; justify-content: space-between; align-items: center; color: white;">
                    <div>
                        <h3 style="margin: 0; font-size: 1.1rem; color: white;">‚ö° One-Click Maintenance</h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.875rem;">Run all recommended operations with one click</p>
                    </div>
                    <button onclick="runRecommendedQuick()" style="background: white; color: var(--accent-color); border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; white-space: nowrap;">
                        ‚ñ∂Ô∏è Run Recommended
                    </button>
                </div>

                <!-- Quick Start Wizard Prompt -->
                <div id="wizard-prompt" class="wizard-prompt" style="background: var(--bg-tertiary); border: 2px dashed var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0; font-size: 1rem;">‚ú® New to Mac Maintenance?</h3>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">Let our Quick Start guide help you choose the right tasks</p>
                    </div>
                    <button onclick="showQuickStartWizard()" class="secondary" style="white-space: nowrap;">
                        Start Guide ‚Üí
                    </button>
                </div>

                <div id="operations-list">
                    <div class="loading">Loading operations...</div>
                </div>
                <div class="button-group">
                    <button class="primary" onclick="runSelectedOperations()" id="run-btn">
                        Run Selected Operations
                    </button>
                    <button class="secondary" onclick="selectAllOperations()" id="select-all-btn">Select All</button>
                    <button class="secondary" onclick="deselectAllOperations()" id="deselect-all-btn">Deselect All</button>
                    <button class="warning" onclick="skipCurrentOperation()" id="skip-btn" style="display:none;">
                        Skip Current
                    </button>
                    <button class="danger" onclick="cancelOperations()" id="cancel-btn" style="display:none;">
                        Cancel All
                    </button>
                </div>

                <!-- Progress Indicator (Task #131) -->
                <div id="progress-container" style="display: none; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #eef1f5 100%); border-radius: 12px; border: 1px solid #e1e4e8; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <!-- Progress Bar -->
                    <div style="margin-bottom: 18px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center;">
                            <span id="progress-label" style="font-weight: 600; color: #24292e; font-size: 15px;">Processing operations...</span>
                            <span id="progress-percent" style="font-weight: 700; color: #0366d6; font-size: 16px;">0%</span>
                        </div>
                        <div style="background: #e1e4e8; height: 10px; border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                            <div id="progress-bar" style="background: linear-gradient(90deg, #34d058, #28a745); height: 100%; width: 0%; transition: width 0.3s ease; box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);"></div>
                        </div>
                    </div>

                    <!-- Operation Stats -->
                    <div style="display: flex; gap: 24px; flex-wrap: wrap; font-size: 14px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">‚è±Ô∏è</span>
                            <div>
                                <div style="color: #586069; font-size: 12px; margin-bottom: 2px;">Current Operation</div>
                                <div id="current-op-timer" style="font-weight: 600; color: #24292e;">0s</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">üìä</span>
                            <div>
                                <div style="color: #586069; font-size: 12px; margin-bottom: 2px;">Progress</div>
                                <div id="ops-progress" style="font-weight: 600; color: #24292e;">0/0</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">‚è≥</span>
                            <div>
                                <div style="color: #586069; font-size: 12px; margin-bottom: 2px;">Est. Remaining</div>
                                <div id="est-remaining" style="font-weight: 600; color: #24292e;">Calculating...</div>
                            </div>
                        </div>
                        <div id="queue-status" style="display: none; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">üìã</span>
                            <div>
                                <div style="color: #586069; font-size: 12px; margin-bottom: 2px;">Queue</div>
                                <div><span id="queue-count" style="font-weight: 600; color: #24292e;">0</span> <span style="color: #586069;">waiting</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Operation Output Area -->
                <div id="operation-output">
                    <div class="progress-output" id="progress-text" style="display: none;">
                        Ready to run operations...
                    </div>
                    <div class="progress-actions" id="inline-progress-actions" style="display: none;">
                        <!-- Copy button will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div id="schedule" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h2>Scheduled Maintenance</h2>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                            Automate maintenance tasks with recurring schedules managed by macOS launchd
                        </p>
                    </div>
                    <button class="primary" onclick="showScheduleModal()">
                        ‚ûï New Schedule
                    </button>
                </div>

                <!-- Template Quick Start -->
                <div id="schedule-templates" style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">üìã Quick Start Templates</h3>
                    <div class="template-grid" id="templates-list">
                        <div class="loading">Loading templates...</div>
                    </div>
                </div>

                <!-- Schedule List -->
                <div id="schedules-list">
                    <div class="loading">Loading schedules...</div>
                </div>
            </div>
        </div>

        <!-- Quick Start Wizard Modal -->
        <div class="modal" id="wizard-modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3>‚ú® Quick Start - What do you want to do?</h3>
                    <button class="modal-close" onclick="closeWizard()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="wizard-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                        <div class="wizard-option" onclick="selectWizardOption('quick')" style="background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s;">
                            <div style="font-size: 3rem; margin-bottom: 0.75rem;">üöÄ</div>
                            <h4 style="margin: 0.5rem 0; font-size: 1.1rem;">Quick Clean</h4>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0.5rem 0 0.75rem 0;">5 minutes - Clear caches and temporary files</p>
                            <div style="color: var(--accent-color); font-size: 0.75rem; font-weight: 600;">2 operations</div>
                        </div>
                        <div class="wizard-option" onclick="selectWizardOption('weekly')" style="background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s;">
                            <div style="font-size: 3rem; margin-bottom: 0.75rem;">üîß</div>
                            <h4 style="margin: 0.5rem 0; font-size: 1.1rem;">Weekly Routine</h4>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0.5rem 0 0.75rem 0;">15 minutes - Recommended maintenance tasks</p>
                            <div style="color: var(--accent-color); font-size: 0.75rem; font-weight: 600;">7 operations</div>
                        </div>
                        <div class="wizard-option" onclick="selectWizardOption('full')" style="background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s;">
                            <div style="font-size: 3rem; margin-bottom: 0.75rem;">üè•</div>
                            <h4 style="margin: 0.5rem 0; font-size: 1.1rem;">Full Checkup</h4>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0.5rem 0 0.75rem 0;">30 minutes - Complete system maintenance</p>
                            <div style="color: var(--accent-color); font-size: 0.75rem; font-weight: 600;">10 operations</div>
                        </div>
                        <div class="wizard-option" onclick="selectWizardOption('custom')" style="background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s;">
                            <div style="font-size: 3rem; margin-bottom: 0.75rem;">üéØ</div>
                            <h4 style="margin: 0.5rem 0; font-size: 1.1rem;">Custom</h4>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0.5rem 0 0.75rem 0;">Choose specific operations yourself</p>
                            <div style="color: var(--accent-color); font-size: 0.75rem; font-weight: 600;">Your choice</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Create/Edit Modal -->
        <div class="modal" id="schedule-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="schedule-modal-title">Create Schedule</h3>
                    <button class="modal-close" onclick="closeScheduleModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="schedule-form">
                        <input type="hidden" id="schedule-id">

                        <div class="form-group">
                            <label for="schedule-name">Schedule Name *</label>
                            <input type="text" id="schedule-name" placeholder="e.g., Weekly System Maintenance" required>
                        </div>

                        <div class="form-group">
                            <label for="schedule-description">Description (optional)</label>
                            <textarea id="schedule-description" rows="4" placeholder="What does this schedule do?" style="resize: vertical; min-height: 80px;"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Maintenance Operations *</label>
                            <div id="schedule-operations" class="operations-selector">
                                <div class="loading">Loading operations...</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="schedule-frequency">Frequency *</label>
                            <select id="schedule-frequency" onchange="updateFrequencyOptions()" required>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>

                        <div class="form-group" id="days-selector" style="display: none;">
                            <label>Days of Week *</label>
                            <div class="days-grid">
                                <label class="day-checkbox">
                                    <input type="checkbox" name="days" value="monday">
                                    <span>Mon</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" name="days" value="tuesday">
                                    <span>Tue</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" name="days" value="wednesday">
                                    <span>Wed</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" name="days" value="thursday">
                                    <span>Thu</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" name="days" value="friday">
                                    <span>Fri</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" name="days" value="saturday">
                                    <span>Sat</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" name="days" value="sunday">
                                    <span>Sun</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group" id="day-selector" style="display: none;">
                            <label for="schedule-day">Day of Month *</label>
                            <input type="number" id="schedule-day" min="1" max="28" placeholder="1-28">
                            <small style="color: var(--text-secondary);">Days 1-28 only (avoids month-end issues)</small>
                        </div>

                        <div class="form-group">
                            <label for="schedule-time">Time of Day *</label>
                            <input type="time" id="schedule-time" value="03:00" required>
                            <small style="color: var(--text-secondary);">Default: 3:00 AM (low system usage)</small>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="schedule-enabled" checked>
                                <span>Enable schedule immediately</span>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="secondary" onclick="closeScheduleModal()">Cancel</button>
                    <button class="primary" onclick="saveSchedule()">Save Schedule</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë   MAC MAINTENANCE - SCRIPT LOADING            ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

        let selectedFiles = new Set();
        let runningOperations = false;
        let operationInvocationId = 0; // Track which invocation is current (prevents race conditions)

        // Progress tracking (Task #131)
        let operationStartTime = 0;  // When current operation started
        let currentOperationIndex = 0;  // Index of current operation
        let totalOperations = 0;  // Total operations to run
        let operationTimes = [];  // Track duration of each completed operation
        let progressTimerInterval = null;  // Timer update interval

        // Queue status polling (Task #129)
        let queueStatusInterval = null;  // Poll queue status every 2 seconds
        let allOperations = [];
        let currentUsername = null; // Will be set from system info

        console.log('‚úì Global variables initialized');
        console.log('‚úì selectedFiles Set created:', selectedFiles);

        // Dashboard enhancement variables
        let sparklineData = { cpu: [], memory: [], disk: [], timestamps: [] };
        let previousMetrics = { cpu: null, memory: null, disk: null };
        let progressOverlayActive = false;
        let progressCancelCallback = null;
        let progressStartTime = null;

        /**
         * Animate a number from old value to new value
         * @param {HTMLElement} element - The element to update
         * @param {number} start - Starting value
         * @param {number} end - Ending value
         * @param {number} duration - Animation duration in ms
         * @param {number} decimals - Number of decimal places
         * @param {string} suffix - Optional suffix (e.g., '%')
         */
        function animateValue(element, start, end, duration = 300, decimals = 1, suffix = '') {
            const startTime = performance.now();
            const delta = end - start;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Ease-out cubic
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const current = start + (delta * easeProgress);

                element.textContent = current.toFixed(decimals) + suffix;

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        /**
         * Calculate trend from history array
         * @param {number[]} history - Array of historical values
         * @returns {string} 'up', 'down', or 'neutral'
         */
        function calculateTrend(history) {
            if (!history || history.length < 2) return 'neutral';

            const recent = history[history.length - 1];
            const previous = history[history.length - 2];
            const delta = recent - previous;

            if (Math.abs(delta) < 0.5) return 'neutral'; // Threshold for neutral
            return delta > 0 ? 'up' : 'down';
        }

        /**
         * Get trend display HTML
         * @param {string} trend - 'up', 'down', or 'neutral'
         * @param {number[]} history - Historical values for delta calculation
         * @returns {string} HTML string for trend indicator
         */
        function getTrendHTML(trend, history) {
            if (!history || history.length < 2) return '';

            const recent = history[history.length - 1];
            const previous = history[history.length - 2];
            const delta = Math.abs(recent - previous).toFixed(1);

            const arrows = {
                up: '‚Üë',
                down: '‚Üì',
                neutral: '‚Ä¢'
            };

            return `<span class="trend ${trend}">${arrows[trend]} ${delta}%</span>`;
        }

        /**
         * Draw sparkline chart on canvas
         * @param {string} canvasId - ID of canvas element
         * @param {number[]} data - Array of data points
         * @param {string} color - Line color
         */
        function drawSparkline(canvasId, data, color = '#0a84ff') {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn(`Canvas not found: ${canvasId}`);
                return;
            }
            if (!data || data.length < 2) {
                console.warn(`Insufficient data for ${canvasId}: ${data ? data.length : 0} points`);
                return;
            }

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Find min/max for scaling
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1; // Avoid division by zero

            // Draw line
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 1.5;
            ctx.lineJoin = 'round';

            data.forEach((value, index) => {
                const x = (index / (data.length - 1)) * width;
                const y = height - ((value - min) / range) * height;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();
        }

        /**
         * Show progress overlay modal
         * @param {string} title - Modal title
         * @param {number} total - Total items to process
         * @param {Function} cancelCallback - Function to call on cancel
         */
        function showProgressOverlay(title, total, cancelCallback) {
            const overlay = document.getElementById('progress-overlay');
            const titleEl = document.getElementById('progress-title');
            const percentEl = document.getElementById('progress-percent');
            const currentEl = document.getElementById('progress-current');
            const barEl = document.getElementById('progress-bar');

            titleEl.textContent = title;
            percentEl.textContent = '0%';
            currentEl.textContent = '0';
            document.getElementById('progress-remaining').textContent = '--';
            barEl.style.width = '0%';

            overlay.classList.add('active');
            progressOverlayActive = true;
            progressCancelCallback = cancelCallback;
            progressStartTime = Date.now();

            // ESC key to close
            document.addEventListener('keydown', handleProgressEscape);
        }

        /**
         * Update progress overlay
         * @param {number} current - Current progress
         * @param {number} total - Total items
         * @param {string} message - Optional status message
         */
        function updateProgressOverlay(current, total, message = '') {
            if (!progressOverlayActive) return;

            const percent = Math.round((current / total) * 100);
            const percentEl = document.getElementById('progress-percent');
            const currentEl = document.getElementById('progress-current');
            const barEl = document.getElementById('progress-bar');
            const remainingEl = document.getElementById('progress-remaining');
            const messageEl = document.getElementById('progress-message');

            // Animate values
            animateValue(percentEl, parseInt(percentEl.textContent), percent, 200, 0, '%');
            currentEl.textContent = current;
            barEl.style.width = percent + '%';

            // Calculate time remaining (exponential moving average)
            if (current > 0 && progressStartTime) {
                const elapsed = (Date.now() - progressStartTime) / 1000; // seconds
                const rate = current / elapsed; // items per second
                const remaining = total - current;
                const eta = remaining / rate; // seconds

                if (eta < 60) {
                    remainingEl.textContent = Math.round(eta) + 's';
                } else {
                    const minutes = Math.floor(eta / 60);
                    const seconds = Math.round(eta % 60);
                    remainingEl.textContent = `${minutes}m ${seconds}s`;
                }
            }

            if (message) {
                messageEl.textContent = message;
            }
        }

        /**
         * Hide progress overlay
         */
        function hideProgressOverlay() {
            const overlay = document.getElementById('progress-overlay');
            overlay.classList.remove('active');
            progressOverlayActive = false;
            progressCancelCallback = null;
            progressStartTime = null;
            document.removeEventListener('keydown', handleProgressEscape);
        }

        /**
         * Cancel progress operation
         */
        function cancelProgress() {
            if (progressCancelCallback) {
                progressCancelCallback();
            }
            hideProgressOverlay();
            showToast('Operation cancelled', 'warning');
        }

        /**
         * Handle ESC key to close progress overlay
         */
        function handleProgressEscape(e) {
            if (e.key === 'Escape' && progressOverlayActive) {
                cancelProgress();
            }
        }

        /**
         * Format time remaining
         * @param {number} seconds - Seconds remaining
         * @returns {string} Formatted time string
         */
        function formatTimeRemaining(seconds) {
            if (seconds < 60) {
                return Math.round(seconds) + 's';
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.round(seconds % 60);
                return `${minutes}m ${secs}s`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}h ${minutes}m`;
            }
        }

        // Theme management (LIGHT | DARK | SYSTEM)
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'system';
            applyTheme(savedTheme);
        }

        function toggleTheme() {
            // Cycle through: light ‚Üí dark ‚Üí system ‚Üí light
            const currentTheme = localStorage.getItem('theme') || 'system';
            let newTheme;

            if (currentTheme === 'light') {
                newTheme = 'dark';
            } else if (currentTheme === 'dark') {
                newTheme = 'system';
            } else {
                newTheme = 'light';
            }

            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function applyTheme(theme) {
            // If system theme, detect browser preference
            let actualTheme = theme;
            if (theme === 'system') {
                actualTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            document.documentElement.setAttribute('data-theme', actualTheme);
            const icon = document.getElementById('theme-icon');
            if (icon) {
                // Show icon based on theme mode
                if (theme === 'light') {
                    icon.textContent = '‚òÄÔ∏è';
                } else if (theme === 'dark') {
                    icon.textContent = 'üåô';
                } else {
                    icon.textContent = 'üñ•Ô∏è';  // System mode
                }
            }
        }

        // Listen for system theme changes when in system mode
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            const savedTheme = localStorage.getItem('theme') || 'system';
            if (savedTheme === 'system') {
                applyTheme('system');
            }
        });

        // Utility: Escape HTML for display (not for attributes - use data-* for those)
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') loadSystemInfo();
            if (tabName === 'maintenance') loadOperations();
            if (tabName === 'schedule') onScheduleTabShow();
        }

        // Dashboard functions
        async function loadSystemInfo() {
            try {
                const response = await fetch('/api/system/info');
                const data = await response.json();

                // Store username globally for use in path buttons
                if (data.system && data.system.username) {
                    currentUsername = data.system.username;
                }

                // Calculate trends
                const cpuTrend = calculateTrend(data.cpu.history);
                const memoryTrend = calculateTrend(data.memory.history);
                const diskTrend = calculateTrend(data.disk.history);

                // System metrics with animations
                const metricsDiv = document.getElementById('system-metrics');
                const isFirstLoad = !previousMetrics.cpu;

                if (isFirstLoad) {
                    // First load: build HTML structure
                    metricsDiv.innerHTML = `
                        <div class="metric-card">
                            <h3>CPU Usage</h3>
                            <div class="value" id="cpu-value">${data.cpu.percent.toFixed(1)}%</div>
                            ${getTrendHTML(cpuTrend, data.cpu.history)}
                            <div class="sparkline-container">
                                <canvas id="cpu-sparkline" class="sparkline" width="80" height="24"></canvas>
                            </div>
                            <div class="subvalue">${data.cpu.count} cores</div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill ${getStatusClass(data.cpu.percent)}" id="cpu-bar"
                                     style="width: ${data.cpu.percent}%"></div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <h3>Memory</h3>
                            <div class="value" id="memory-value">${data.memory.percent.toFixed(1)}%</div>
                            ${getTrendHTML(memoryTrend, data.memory.history)}
                            <div class="sparkline-container">
                                <canvas id="memory-sparkline" class="sparkline" width="80" height="24"></canvas>
                            </div>
                            <div class="subvalue">${data.memory.available_gb.toFixed(1)} GB available</div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill ${getStatusClass(data.memory.percent)}" id="memory-bar"
                                     style="width: ${data.memory.percent}%"></div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <h3>Disk Space</h3>
                            <div class="value" id="disk-value">${data.disk.percent.toFixed(1)}%</div>
                            ${getTrendHTML(diskTrend, data.disk.history)}
                            <div class="sparkline-container">
                                <canvas id="disk-sparkline" class="sparkline" width="80" height="24"></canvas>
                            </div>
                            <div class="subvalue">${data.disk.free_gb.toFixed(1)} GB free of ${data.disk.total_gb.toFixed(1)} GB</div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill ${getStatusClass(data.disk.percent)}" id="disk-bar"
                                     style="width: ${data.disk.percent}%"></div>
                            </div>
                        </div>
                    `;

                    // Debug: Verify memory bar was created
                    console.log('First load - Memory bar HTML rendered');
                    setTimeout(() => {
                        const memBar = document.getElementById('memory-bar');
                        if (memBar) {
                            console.log('Memory bar found after first load:', {
                                width: memBar.style.width,
                                className: memBar.className,
                                computedWidth: window.getComputedStyle(memBar).width,
                                parent: memBar.parentElement
                            });
                        } else {
                            console.error('Memory bar NOT found after first load!');
                        }
                    }, 100);
                } else {
                    // Subsequent loads: animate values
                    const cpuValueEl = document.getElementById('cpu-value');
                    const memoryValueEl = document.getElementById('memory-value');
                    const diskValueEl = document.getElementById('disk-value');

                    if (cpuValueEl) {
                        animateValue(cpuValueEl, previousMetrics.cpu, data.cpu.percent, 300, 1, '%');
                    }
                    if (memoryValueEl) {
                        animateValue(memoryValueEl, previousMetrics.memory, data.memory.percent, 300, 1, '%');
                    }
                    if (diskValueEl) {
                        animateValue(diskValueEl, previousMetrics.disk, data.disk.percent, 300, 1, '%');
                    }

                    // Update progress bars smoothly
                    const cpuBar = document.getElementById('cpu-bar');
                    const memoryBar = document.getElementById('memory-bar');
                    const diskBar = document.getElementById('disk-bar');

                    // Debug logging for memory bar
                    if (!memoryBar) {
                        console.error('Memory bar element not found!');
                    } else {
                        console.log(`Memory bar found: width=${data.memory.percent}%, element:`, memoryBar);
                    }

                    if (cpuBar) {
                        cpuBar.style.width = data.cpu.percent + '%';
                        cpuBar.className = `progress-bar-fill ${getStatusClass(data.cpu.percent)}`;
                    }
                    if (memoryBar) {
                        memoryBar.style.width = data.memory.percent + '%';
                        memoryBar.className = `progress-bar-fill ${getStatusClass(data.memory.percent)}`;
                    }
                    if (diskBar) {
                        diskBar.style.width = data.disk.percent + '%';
                        diskBar.className = `progress-bar-fill ${getStatusClass(data.disk.percent)}`;
                    }

                    // Update trend indicators (recreate HTML for simplicity)
                    const cpuCard = document.querySelector('.metric-card:nth-child(1)');
                    const memoryCard = document.querySelector('.metric-card:nth-child(2)');
                    const diskCard = document.querySelector('.metric-card:nth-child(3)');

                    if (cpuCard) {
                        const existingTrend = cpuCard.querySelector('.trend');
                        if (existingTrend) existingTrend.remove();
                        const valueDiv = cpuCard.querySelector('.value');
                        valueDiv.insertAdjacentHTML('afterend', getTrendHTML(cpuTrend, data.cpu.history));
                    }
                    if (memoryCard) {
                        const existingTrend = memoryCard.querySelector('.trend');
                        if (existingTrend) existingTrend.remove();
                        const valueDiv = memoryCard.querySelector('.value');
                        valueDiv.insertAdjacentHTML('afterend', getTrendHTML(memoryTrend, data.memory.history));
                    }
                    if (diskCard) {
                        const existingTrend = diskCard.querySelector('.trend');
                        if (existingTrend) existingTrend.remove();
                        const valueDiv = diskCard.querySelector('.value');
                        valueDiv.insertAdjacentHTML('afterend', getTrendHTML(diskTrend, data.disk.history));
                    }
                }

                // Store current metrics for next animation
                previousMetrics.cpu = data.cpu.percent;
                previousMetrics.memory = data.memory.percent;
                previousMetrics.disk = data.disk.percent;

                // Fetch full sparkline data and draw
                fetch('/api/system/sparkline')
                    .then(res => res.json())
                    .then(sparkData => {
                        console.log('Sparkline data received:', sparkData);
                        if (sparkData && sparkData.cpu && sparkData.cpu.length >= 2) {
                            drawSparkline('cpu-sparkline', sparkData.cpu, '#ff6961');
                            drawSparkline('memory-sparkline', sparkData.memory, '#0a84ff');
                            drawSparkline('disk-sparkline', sparkData.disk, '#ff9500');
                        } else {
                            console.warn('Sparkline data insufficient:', sparkData);
                        }
                    })
                    .catch(err => console.error('Error loading sparkline data:', err));

                // System info
                document.getElementById('system-info').innerHTML = `
                    <dl class="info-item">
                        <dt>Total Memory</dt>
                        <dd>${data.memory.total_gb.toFixed(1)} GB</dd>
                    </dl>
                    <dl class="info-item">
                        <dt>Used Memory</dt>
                        <dd>${data.memory.used_gb.toFixed(1)} GB</dd>
                    </dl>
                    <dl class="info-item">
                        <dt>Total Disk</dt>
                        <dd>${data.disk.total_gb.toFixed(1)} GB</dd>
                    </dl>
                    <dl class="info-item">
                        <dt>Used Disk</dt>
                        <dd>${data.disk.used_gb.toFixed(1)} GB</dd>
                    </dl>
                `;

                // Maintenance status - Load last run time from API
                const diskWarning = data.disk.percent > 80 ?
                    `<div class="warning">‚ö†Ô∏è Disk usage is high (${data.disk.percent.toFixed(1)}%). Consider running cleanup operations.</div>` : '';
                const memoryWarning = data.memory.percent > 80 ?
                    `<div class="warning">‚ö†Ô∏è Memory usage is high (${data.memory.percent.toFixed(1)}%).</div>` : '';

                // Fetch last maintenance run time
                loadLastMaintenanceRun(diskWarning, memoryWarning);

            } catch (error) {
                document.getElementById('system-metrics').innerHTML =
                    `<div class="error">Error loading system info: ${error.message}</div>`;
            }
        }

        /**
         * Load and display system health score
         */
        async function loadHealthScore() {
            const healthDiv = document.getElementById('health-score');
            try {
                const response = await fetch('/api/system/health');
                const data = await response.json();

                let issuesHTML = '';
                if (data.issues && data.issues.length > 0) {
                    issuesHTML = `
                        <div class="health-issues" style="margin-top: 1rem; text-align: left;">
                            <h4 style="margin-bottom: 0.5rem;">Issues Detected:</h4>
                            ${data.issues.map(issue => `
                                <div class="warning" style="margin-bottom: 0.5rem;">
                                    ${issue.includes('Critical') ? 'üî¥' : '‚ö†Ô∏è'} ${issue}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                healthDiv.innerHTML = `
                    <div class="health-score-value ${data.overall}">
                        ${data.score}
                    </div>
                    <div class="health-status">${data.overall.toUpperCase()}</div>
                    ${issuesHTML}
                `;
            } catch (error) {
                healthDiv.innerHTML = `<div class="error">Error loading health score: ${error.message}</div>`;
            }
        }

        /**
         * Load and display top resource consumers
         */
        async function loadTopProcesses() {
            const processesDiv = document.getElementById('top-processes');
            try {
                const response = await fetch('/api/system/processes?limit=3');
                const data = await response.json();

                let html = '<div class="process-section">';
                html += '<h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Top CPU Consumers</h3>';
                html += '<div class="process-list">';
                data.top_cpu.forEach((proc, idx) => {
                    html += `
                        <div class="process-item">
                            <div class="process-rank">${idx + 1}</div>
                            <div class="process-name">${proc.name}</div>
                            <div class="process-value">${proc.cpu_percent}%</div>
                        </div>
                    `;
                });
                html += '</div></div>';

                html += '<div class="process-section" style="margin-top: 1.5rem;">';
                html += '<h3 style="font-size: 0.875rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Top Memory Consumers</h3>';
                html += '<div class="process-list">';
                data.top_memory.forEach((proc, idx) => {
                    html += `
                        <div class="process-item">
                            <div class="process-rank">${idx + 1}</div>
                            <div class="process-name">${proc.name}</div>
                            <div class="process-value">${proc.memory_mb.toFixed(0)} MB</div>
                        </div>
                    `;
                });
                html += '</div></div>';

                processesDiv.innerHTML = html;
            } catch (error) {
                processesDiv.innerHTML = `<div class="error">Error loading processes: ${error.message}</div>`;
            }
        }

        /**
         * Load and display last maintenance run time
         * @param {string} diskWarning - HTML for disk warning (if any)
         * @param {string} memoryWarning - HTML for memory warning (if any)
         */
        async function loadLastMaintenanceRun(diskWarning = '', memoryWarning = '') {
            const statusDiv = document.getElementById('maintenance-status');
            try {
                const response = await fetch('/api/maintenance/last-run');
                const data = await response.json();

                let lastRunText;
                if (data.status === 'never') {
                    lastRunText = '<strong>Never</strong>';
                } else {
                    // API returns global_last_run and global_last_run_relative
                    const lastRun = data.global_last_run || 'Unknown';
                    const relative = data.global_last_run_relative || '';
                    lastRunText = `<strong>${lastRun}</strong> <span style="color: var(--text-secondary);">(${relative})</span>`;
                }

                statusDiv.innerHTML = `
                    <p>Last maintenance run: ${lastRunText}</p>
                    <p style="margin-top: 0.5rem;">Recommendation: <strong>Run maintenance weekly</strong></p>
                    ${diskWarning}
                    ${memoryWarning}
                    ${!diskWarning && !memoryWarning ? '<div class="success">‚úì System is running smoothly</div>' : ''}
                `;
            } catch (error) {
                // Fallback to "Never" if API fails
                statusDiv.innerHTML = `
                    <p>Last maintenance run: <strong>Never</strong> <span style="color: var(--text-secondary);">(check logs)</span></p>
                    <p style="margin-top: 0.5rem;">Recommendation: <strong>Run maintenance weekly</strong></p>
                    ${diskWarning}
                    ${memoryWarning}
                    ${!diskWarning && !memoryWarning ? '<div class="success">‚úì System is running smoothly</div>' : ''}
                `;
            }
        }

        // Storage functions
        async function analyzeStorage() {
            const path = document.getElementById('path-input').value || '/Users';
            const resultsDiv = document.getElementById('storage-results');
            const analyzeBtn = document.getElementById('analyze-btn-text');

            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div> Analyzing storage...</div>';
            analyzeBtn.innerHTML = '<div class="spinner"></div>';
            selectedFiles.clear();
            updateBreadcrumbs(path);

            try {
                const response = await fetch(`/api/storage/analyze?path=${encodeURIComponent(path)}`);

                // Check if response is OK before parsing
                if (!response.ok) {
                    let errorMsg = `Server error: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.detail || errorMsg;
                    } catch {
                        // Response is not JSON, use status message
                    }
                    analyzeBtn.textContent = 'Analyze';
                    resultsDiv.innerHTML = `<div class="error">${errorMsg}</div>`;
                    showToast(errorMsg, 'error');
                    return;
                }

                const data = await response.json();
                analyzeBtn.textContent = 'Analyze';

                if (!data.success) {
                    const errorMsg = data.error || 'Unknown error occurred';
                    resultsDiv.innerHTML = `<div class="error">${errorMsg}</div>`;
                    showToast(errorMsg, 'error');
                    return;
                }

                showToast(`Analyzed: ${data.file_count} files, ${data.total_size_gb.toFixed(2)} GB`, 'success');

                resultsDiv.innerHTML = `
                    <h3 style="margin-top: 2rem;">Results for ${data.path}</h3>
                    <div class="metric-grid" style="margin-top: 1rem;">
                        <div class="metric-card">
                            <h3>Total Size</h3>
                            <div class="value">${data.total_size_gb.toFixed(2)} GB</div>
                        </div>
                        <div class="metric-card">
                            <h3>Files</h3>
                            <div class="value">${data.file_count.toLocaleString()}</div>
                        </div>
                        <div class="metric-card">
                            <h3>Directories</h3>
                            <div class="value">${data.dir_count.toLocaleString()}</div>
                        </div>
                    </div>
                    <h3 style="margin-top: 2rem;">Largest Items</h3>
                    <p style="color: #6e6e73; margin-top: 0.5rem;">Select items to delete</p>
                    <div class="file-list">
                        ${data.largest_entries.map((entry, idx) => {
                            const displayName = entry.path.split('/').pop();
                            return `
                            <div class="file-item">
                                <input type="checkbox" id="file-${idx}" data-path="${entry.path.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
                                <div class="file-info">
                                    <strong>${displayName}</strong><br>
                                    <small style="color: #6e6e73;">${entry.path}</small>
                                </div>
                                <div class="file-size">
                                    <strong>${entry.size_gb.toFixed(2)} GB</strong><br>
                                    <small style="color: #6e6e73;">${entry.is_dir ? 'Directory' : 'File'}</small>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                    <div class="button-group">
                        <button class="primary" id="trash-btn">
                            üóëÔ∏è Move to Trash (<span id="selected-count">0</span>)
                        </button>
                        <button class="danger" id="permanent-delete-btn">
                            ‚ö†Ô∏è Permanently Delete (<span id="selected-count-permanent">0</span>)
                        </button>
                        <button class="secondary" id="select-all-btn">Select All</button>
                        <button class="secondary" id="deselect-all-btn">Deselect All</button>
                    </div>
                `;

                // Attach event listeners AFTER HTML is inserted
                console.log('=== ATTACHING EVENT LISTENERS ===');
                const trashBtn = document.getElementById('trash-btn');
                const permBtn = document.getElementById('permanent-delete-btn');
                const selAllBtn = document.getElementById('select-all-btn');
                const deselAllBtn = document.getElementById('deselect-all-btn');

                console.log('Trash button found:', trashBtn);
                console.log('Permanent button found:', permBtn);

                if (trashBtn) {
                    trashBtn.addEventListener('click', () => {
                        console.log('TRASH BUTTON CLICKED!');
                        deleteSelected('trash');
                    });
                    console.log('‚úì Trash button listener attached');
                }

                if (permBtn) {
                    permBtn.addEventListener('click', () => {
                        console.log('PERMANENT DELETE BUTTON CLICKED!');
                        deleteSelected('permanent');
                    });
                    console.log('‚úì Permanent button listener attached');
                }

                if (selAllBtn) {
                    selAllBtn.addEventListener('click', selectAllFiles);
                    console.log('‚úì Select all button listener attached');
                }

                if (deselAllBtn) {
                    deselAllBtn.addEventListener('click', deselectAllFiles);
                    console.log('‚úì Deselect all button listener attached');
                }

                // Attach checkbox event listeners
                const checkboxes = document.querySelectorAll('#storage-results input[type="checkbox"]');
                console.log('Found checkboxes:', checkboxes.length);
                checkboxes.forEach((checkbox, idx) => {
                    checkbox.addEventListener('change', () => {
                        console.log(`Checkbox ${idx} changed, path:`, checkbox.dataset.path);
                        toggleFileSelection(checkbox.dataset.path);
                    });
                });
                console.log('‚úì All checkbox listeners attached');

            } catch (error) {
                const errorMsg = error.message || 'Failed to analyze storage';
                resultsDiv.innerHTML = `<div class="error">Error: ${errorMsg}</div>`;
                analyzeBtn.textContent = 'Analyze';
                showToast(errorMsg, 'error');
            }
        }

        function toggleFileSelection(path) {
            console.log('toggleFileSelection called with:', path);
            console.log('selectedFiles before:', Array.from(selectedFiles));
            if (selectedFiles.has(path)) {
                selectedFiles.delete(path);
                console.log('Removed path');
            } else {
                selectedFiles.add(path);
                console.log('Added path');
            }
            console.log('selectedFiles after:', Array.from(selectedFiles));
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = selectedFiles.size;
            const countEl = document.getElementById('selected-count');
            const countElPermanent = document.getElementById('selected-count-permanent');
            if (countEl) countEl.textContent = count;
            if (countElPermanent) countElPermanent.textContent = count;
        }

        function selectAllFiles() {
            document.querySelectorAll('#storage-results input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
                if (cb.dataset.path) {
                    selectedFiles.add(cb.dataset.path);
                }
            });
            updateSelectedCount();
        }

        function deselectAllFiles() {
            document.querySelectorAll('#storage-results input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            selectedFiles.clear();
            updateSelectedCount();
        }

        async function deleteSelected(mode = 'trash') {
            console.log('=== deleteSelected CALLED ===');
            console.log('Mode:', mode);
            console.log('selectedFiles.size:', selectedFiles.size);
            console.log('selectedFiles contents:', Array.from(selectedFiles));

            if (selectedFiles.size === 0) {
                console.log('No files selected, showing toast');
                showToast('No files selected', 'warning');
                return;
            }

            // Different confirmation messages based on mode
            let confirmMessage;
            if (mode === 'permanent') {
                confirmMessage = `‚ö†Ô∏è PERMANENTLY DELETE ${selectedFiles.size} item(s)?\n\n` +
                                `This CANNOT be undone! Files will be deleted forever.\n\n` +
                                `Consider using "Move to Trash" instead (recoverable).`;
            } else {
                confirmMessage = `Move ${selectedFiles.size} item(s) to Trash?\n\n` +
                                `You can recover them from macOS Trash if needed.`;
            }

            console.log('Showing confirmation dialog');
            // TEMPORARILY DISABLED FOR TESTING - browser is blocking confirms
            // const confirmed = confirm(confirmMessage);
            const confirmed = true; // Auto-confirm for testing
            console.log('User confirmed:', confirmed);

            if (!confirmed) {
                console.log('User cancelled');
                return;
            }

            console.log('Proceeding with delete...');

            const totalFiles = selectedFiles.size;
            let deleted = 0;
            let failed = 0;
            const failedPaths = [];
            let operationCancelled = false;

            // Disable both buttons
            const trashBtn = document.getElementById('trash-btn');
            const permanentBtn = document.getElementById('permanent-delete-btn');
            trashBtn.disabled = true;
            permanentBtn.disabled = true;

            // Show progress overlay
            const actionTitle = mode === 'permanent' ? '‚ö†Ô∏è Permanently Deleting Files...' : 'üóëÔ∏è Moving Files to Trash...';
            showProgressOverlay(actionTitle, totalFiles, () => {
                operationCancelled = true;
            });

            // Delete each file sequentially with progress updates
            let current = 0;
            for (const path of selectedFiles) {
                // Check if operation was cancelled
                if (operationCancelled) {
                    break;
                }

                current++;
                const fileName = path.split('/').pop();
                updateProgressOverlay(current, totalFiles, `Processing: ${fileName}`);

                try {
                    const response = await fetch(`/api/storage/delete?path=${encodeURIComponent(path)}&mode=${mode}`, {
                        method: 'DELETE'
                    });

                    // Check response status
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                        throw new Error(errorData.detail || `HTTP ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        deleted++;
                    } else {
                        failed++;
                        failedPaths.push({ path, error: result.error || 'Unknown error' });
                        console.error(`Failed to ${mode === 'permanent' ? 'delete' : 'move to trash'} ${path}:`, result.error);
                    }
                } catch (error) {
                    failed++;
                    failedPaths.push({ path, error: error.message });
                    console.error(`Error processing ${path}:`, error);
                }
            }

            // Hide progress overlay
            hideProgressOverlay();

            // Re-enable buttons
            trashBtn.disabled = false;
            permanentBtn.disabled = false;

            // Clear selection
            selectedFiles.clear();
            updateSelectedCount();

            // Show final results
            const successVerb = mode === 'permanent' ? 'deleted' : 'moved to Trash';
            const failedVerb = mode === 'permanent' ? 'delete' : 'move';

            if (operationCancelled) {
                showToast(`‚ö†Ô∏è Operation cancelled. Processed ${deleted + failed}/${totalFiles} items.`, 'warning', 4000);
            } else if (deleted > 0 && failed === 0) {
                showToast(`‚úÖ Successfully ${successVerb} ${deleted} item(s)`, 'success', 4000);
                if (mode === 'trash') {
                    showToast('üí° Tip: You can recover files from macOS Trash', 'info', 3000);
                }
            } else if (deleted > 0 && failed > 0) {
                showToast(`‚ö†Ô∏è ${successVerb.charAt(0).toUpperCase() + successVerb.slice(1)} ${deleted}, failed to ${failedVerb} ${failed} item(s)`, 'warning', 6000);
                console.error('Failed operations:', failedPaths);
            } else {
                showToast(`‚ùå Failed to ${failedVerb} all ${failed} item(s)`, 'error', 6000);
                console.error('Failed operations:', failedPaths);
            }

            // CRITICAL: Refresh storage view to verify actual filesystem state
            // This ensures UI matches reality ("trust but verify")
            showToast('Refreshing view...', 'info', 2000);
            await analyzeStorage();
        }

        // Maintenance functions
        async function loadOperations() {
            try {
                // Add cache-busting parameter to force fresh data
                const cacheBuster = Date.now();
                const response = await fetch(`/api/maintenance/operations?_=${cacheBuster}`);
                const data = await response.json();

                if (!data.operations || data.operations.length === 0) {
                    document.getElementById('operations-list').innerHTML =
                        '<div class="error">No operations available</div>';
                    return;
                }

                allOperations = data.operations;

                // Debug: Log first operation to check if why/what data exists
                console.log('=== WHY/WHAT DEBUG ===');
                console.log('Total operations loaded:', allOperations.length);
                console.log('First operation full data:', allOperations[0]);

                // Count how many operations have why/what data
                const opsWithData = allOperations.filter(op => op.why && op.what);
                const opsWithoutData = allOperations.filter(op => !op.why || !op.what);
                console.log(`Operations WITH why/what: ${opsWithData.length}`);
                console.log(`Operations WITHOUT why/what: ${opsWithoutData.length}`);
                if (opsWithoutData.length > 0) {
                    console.log('Operations missing why/what:', opsWithoutData.map(op => op.id));
                }
                console.log('=== END DEBUG ===');

                // Sort by category for better organization
                allOperations.sort((a, b) => {
                    if (a.category === b.category) {
                        return a.name.localeCompare(b.name);
                    }
                    return a.category.localeCompare(b.category);
                });

                // Fetch per-operation last run data
                let operationsHistory = {};
                try {
                    const lastRunResponse = await fetch('/api/maintenance/last-run');
                    const lastRunData = await lastRunResponse.json();
                    operationsHistory = lastRunData.operations || {};
                } catch (error) {
                    console.warn('Could not fetch per-operation history:', error);
                }

                const html = allOperations.map(op => {
                    // Get per-operation last run info
                    const opHistory = operationsHistory[op.id];
                    let lastRunHtml = '';
                    if (opHistory && opHistory.last_run_relative) {
                        const statusIcon = opHistory.success ? '‚úì' : '‚úó';
                        const statusColor = opHistory.success ? 'var(--success-color)' : 'var(--error-color)';
                        lastRunHtml = `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            üìÖ Last run: <strong>${opHistory.last_run_relative}</strong> <span style="color: ${statusColor}">${statusIcon}</span>
                        </div>`;
                    } else {
                        lastRunHtml = `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                            üìÖ Last run: <strong>Never run</strong>
                        </div>`;
                    }

                    // Build WHY/WHAT accordion if data is available
                    let whyWhatHtml = '';
                    // Debug: Always log why/what availability for debugging
                    console.log(`Operation ${op.id}: has why=${!!op.why}, has what=${!!op.what}`, op.why ? 'why data present' : 'why MISSING', op.what ? 'what data present' : 'what MISSING');
                    if (op.why && op.what) {
                        // Build when to run list
                        let whenToRunHtml = '';
                        if (op.when_to_run && op.when_to_run.length > 0) {
                            whenToRunHtml = `
                                <div class="operation-when">
                                    <h5>üìÖ When to Run This</h5>
                                    <ul>
                                        ${op.when_to_run.map(when => `<li>${when}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        }

                        // Build context info
                        let contextHtml = '';
                        if (op.why.context) {
                            contextHtml = `<p class="operation-context">${op.why.context}</p>`;
                        }

                        // Build problems list
                        let problemsHtml = '';
                        if (op.why.problems && op.why.problems.length > 0) {
                            problemsHtml = op.why.problems.map(problem =>
                                `<li><strong>${problem.symptom}</strong><br>${problem.description}</li>`
                            ).join('');
                        }

                        // Build outcomes list
                        let outcomesHtml = '';
                        if (op.what.outcomes && op.what.outcomes.length > 0) {
                            outcomesHtml = op.what.outcomes.map(outcome => {
                                const icon = outcome.type === 'positive' ? '‚úÖ' :
                                            outcome.type === 'warning' ? '‚ö†Ô∏è' :
                                            outcome.type === 'temporary' ? '‚è±Ô∏è' : '‚ÑπÔ∏è';
                                return `<li>${icon} ${outcome.description}</li>`;
                            }).join('');
                        }

                        // Build timeline info
                        let timelineHtml = '';
                        if (op.what.timeline) {
                            timelineHtml = `<p class="operation-timeline"><strong>‚è±Ô∏è How Long:</strong> ${op.what.timeline}</p>`;
                        }

                        whyWhatHtml = `
                            <details class="operation-details">
                                <summary>‚ÑπÔ∏è Why run this & What to expect</summary>
                                <div class="operation-details-content">
                                    ${whenToRunHtml}
                                    ${contextHtml}
                                    <div class="operation-why">
                                        <h5>üîç Problems This Solves</h5>
                                        <ul>${problemsHtml}</ul>
                                    </div>
                                    <div class="operation-what">
                                        <h5>‚ú® What Happens After Running</h5>
                                        <ul>${outcomesHtml}</ul>
                                        ${timelineHtml}
                                    </div>
                                </div>
                            </details>
                        `;
                    }

                    return `
                        <div class="operation-item" data-operation-id="${op.id}">
                            <input type="checkbox" id="op-${op.id}" value="${op.id}"
                                   ${op.recommended ? 'checked' : ''}>
                            <div class="operation-info">
                                <h4>
                                    ${op.name}
                                    ${op.recommended ? '<span class="badge recommended">Recommended</span>' : '<span class="badge optional">Optional</span>'}
                                </h4>
                                <p>${op.description}</p>
                                ${whyWhatHtml}
                                ${lastRunHtml}
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('operations-list').innerHTML = html;

                const selectedCount = allOperations.filter(op => op.recommended).length;
                showToast(`Loaded ${allOperations.length} operations (${selectedCount} recommended)`, 'success', 2000);

                // Fetch and display global last maintenance run timestamp
                try {
                    const lastRunResponse = await fetch('/api/maintenance/last-run');
                    const lastRunData = await lastRunResponse.json();

                    // Remove any existing info-banner to prevent duplicates
                    const existingBanners = document.querySelectorAll('.info-banner');
                    existingBanners.forEach(banner => banner.remove());

                    if (lastRunData.success && lastRunData.status === 'completed') {
                        const banner = document.createElement('div');
                        banner.className = 'info-banner';
                        banner.style.cssText = 'padding: 0.75rem; background: var(--success-bg); color: var(--success-color); border-radius: 6px; margin-bottom: 1rem; font-size: 0.875rem;';
                        // API returns global_last_run_relative
                        const relative = lastRunData.global_last_run_relative || 'Recently';
                        banner.innerHTML = `üìÖ Last maintenance run: <strong>${relative}</strong>`;
                        document.getElementById('operations-list').insertAdjacentElement('beforebegin', banner);
                    } else if (lastRunData.status === 'never') {
                        const banner = document.createElement('div');
                        banner.className = 'info-banner';
                        banner.style.cssText = 'padding: 0.75rem; background: var(--warning-bg); color: var(--warning-color); border-radius: 6px; margin-bottom: 1rem; font-size: 0.875rem;';
                        banner.innerHTML = `‚ÑπÔ∏è Maintenance has never been run`;
                        document.getElementById('operations-list').insertAdjacentElement('beforebegin', banner);
                    }
                } catch (error) {
                    console.warn('Could not fetch last run info:', error);
                }
            } catch (error) {
                console.error('Error loading operations:', error);
                document.getElementById('operations-list').innerHTML =
                    `<div class="error">Error loading operations: ${error.message}</div>`;
                showToast('Failed to load operations', 'error');
            }
        }

        function selectAllOperations() {
            const checkboxes = document.querySelectorAll('#operations-list input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            showToast(`Selected all ${checkboxes.length} operations`, 'info', 2000);
        }

        function deselectAllOperations() {
            const checkboxes = document.querySelectorAll('#operations-list input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            showToast('Deselected all operations', 'info', 2000);
        }

        function applyTemplate(template) {
            console.log('Applying template:', template);

            // First, deselect all operations
            const checkboxes = document.querySelectorAll('#operations-list input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);

            // Then select operations from the template
            if (template.operations && template.operations.length > 0) {
                let selectedCount = 0;
                template.operations.forEach(opId => {
                    const checkbox = document.getElementById(`op-${opId}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        selectedCount++;
                    } else {
                        console.warn(`Operation not found: ${opId}`);
                    }
                });

                showToast(`Applied "${template.name}" - ${selectedCount} operations selected`, 'success', 3000);
            } else {
                showToast(`Applied "${template.name}"`, 'info', 2000);
            }
        }

        async function runSelectedOperations() {
            console.log('=== runSelectedOperations CALLED ===');
            const checkboxes = document.querySelectorAll('#operations-list input[type="checkbox"]:checked');
            console.log('Found checked checkboxes:', checkboxes.length);
            const selected = Array.from(checkboxes).map(cb => cb.value);
            console.log('Selected operations:', selected);

            if (selected.length === 0) {
                console.log('No operations selected');
                alert('No operations selected');
                return;
            }

            // Build list of selected operation names for confirmation
            const selectedOps = allOperations.filter(op => selected.includes(op.id));
            const opList = selectedOps.map(op => `  ‚Ä¢ ${op.name}`).join('\n');

            // Removed confirmation dialog - user feedback: "feels like friction, unnecessary extra step"
            console.log('Proceeding with operations...');

            // Increment invocation ID to track this specific run (Task #123 fix)
            // This prevents race conditions where old invocations hide buttons after new ones show them
            operationInvocationId++;
            const thisInvocationId = operationInvocationId;
            console.log('Operation invocation ID:', thisInvocationId);

            runningOperations = true;
            document.getElementById('run-btn').disabled = true;

            // Show Skip/Cancel buttons explicitly (Task #123 fix)
            // Use 'inline-block' instead of '' to ensure buttons are visible
            // The empty string '' can cause issues with CSS specificity
            const skipBtn = document.getElementById('skip-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            skipBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            console.log('Showing Skip/Cancel buttons for invocation', thisInvocationId);

            // Task #131: Show progress container and initialize progress
            const progressContainer = document.getElementById('progress-container');
            progressContainer.style.display = 'block';
            currentOperationIndex = 0;
            totalOperations = selected.length;
            operationTimes = [];
            updateProgress();
            startProgressTimer();
            startQueueStatusPolling();

            // Task #124: Disable Select All/Deselect All buttons during operations
            document.getElementById('select-all-btn').disabled = true;
            document.getElementById('deselect-all-btn').disabled = true;

            // Show and populate output area
            const progressText = document.getElementById('progress-text');
            if (progressText) {
                progressText.style.display = 'block';
                progressText.textContent = 'Connecting to server...\n';
                // Scroll output area into view
                progressText.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            try {
                const response = await fetch('/api/maintenance/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        operation_ids: selected
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to start operations');
                }

                // Handle Server-Sent Events stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        break;
                    }

                    // Decode and process SSE data
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonData = line.slice(6);
                            try {
                                const event = JSON.parse(jsonData);
                                handleOperationEvent(event);
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                const progressText = document.getElementById('progress-text');
                if (progressText) {
                    progressText.textContent += `\n\nError: ${error.message}\n`;
                }
                console.error('Error running operations:', error);
            } finally {
                // Only cleanup if this is still the current invocation (Task #123 fix)
                // Prevents race condition where old invocation hides buttons after new one shows them
                if (thisInvocationId === operationInvocationId) {
                    console.log('Cleaning up invocation', thisInvocationId, '(current)');
                    document.getElementById('run-btn').disabled = false;
                    document.getElementById('skip-btn').style.display = 'none';
                    document.getElementById('cancel-btn').style.display = 'none';
                    runningOperations = false;

                    // Task #131: Stop timers and hide progress container
                    stopProgressTimer();
                    stopQueueStatusPolling();
                    document.getElementById('progress-container').style.display = 'none';

                    // Task #124: Re-enable Select All/Deselect All buttons
                    document.getElementById('select-all-btn').disabled = false;
                    document.getElementById('deselect-all-btn').disabled = false;
                } else {
                    console.log('Skipping cleanup for invocation', thisInvocationId, '(superseded by', operationInvocationId, ')');
                }
            }
        }

        async function skipCurrentOperation() {
            if (!confirm('Skip the current operation and move to the next?')) {
                return;
            }

            try {
                const response = await fetch('/api/maintenance/skip', {
                    method: 'POST'
                });

                const result = await response.json();

                const progressText = document.getElementById('progress-text');
                if (progressText) {
                    progressText.textContent += `\n\n‚è≠Ô∏è ${result.message}\n`;
                }

            } catch (error) {
                console.error('Error skipping operation:', error);
                alert('Error skipping operation: ' + error.message);
            }
        }

        function handleOperationEvent(event) {
            const progressText = document.getElementById('progress-text');
            if (!progressText) return;

            switch (event.type) {
                case 'start':
                    progressText.textContent += `\n${event.message}\n`;
                    progressText.textContent += `${'='.repeat(60)}\n\n`;

                    // Hide copy button when starting new operations
                    const inlineActionsStart = document.getElementById('inline-progress-actions');
                    if (inlineActionsStart) {
                        inlineActionsStart.style.display = 'none';
                        inlineActionsStart.innerHTML = '';
                    }

                    // Auto-scroll to bottom so entire output window is visible (UX: hide buttons, show full output)
                    // Use setTimeout to ensure DOM has updated before scrolling
                    setTimeout(() => {
                        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                    }, 50);
                    break;

                case 'operation_start':
                    progressText.textContent += `\n[${event.progress}] Starting: ${event.operation_name}\n`;
                    progressText.textContent += `${'-'.repeat(60)}\n`;

                    // Task #131: Start operation timer
                    operationStartTime = Date.now();
                    currentOperationIndex++;
                    updateProgress();
                    break;

                case 'output':
                    progressText.textContent += `${event.line}\n`;
                    progressText.scrollTop = progressText.scrollHeight; // Auto-scroll
                    break;

                case 'operation_complete':
                    const status = event.success ? '‚úì Success' : '‚úó Failed';
                    const color = event.success ? 'green' : 'red';
                    progressText.textContent += `\n${status} (exit code: ${event.returncode})\n`;

                    // Task #131: Track operation duration
                    if (operationStartTime > 0) {
                        const duration = Date.now() - operationStartTime;
                        operationTimes.push(duration);
                        updateProgress();
                    }
                    break;

                case 'operation_skipped':
                    progressText.textContent += `\n‚è≠Ô∏è  Skipped by user\n`;
                    break;

                case 'operation_error':
                    progressText.textContent += `\nError: ${event.message}\n`;
                    break;

                case 'summary':
                    progressText.textContent += `\n${'='.repeat(60)}\n`;
                    progressText.textContent += `\nSummary:\n`;
                    progressText.textContent += `  Total operations: ${event.total}\n`;
                    progressText.textContent += `  Successful: ${event.successful}\n`;
                    progressText.textContent += `  Failed: ${event.failed}\n`;
                    break;

                case 'complete':
                    progressText.textContent += `\n${event.message}\n`;
                    progressText.textContent += `${'='.repeat(60)}\n`;

                    // Task #130: Refresh "Last run" timestamp after all operations complete
                    refreshLastRunTimestamp();

                    // Add copy to clipboard button when operations complete
                    // Use inline progress actions container (not modal)
                    const inlineActions = document.getElementById('inline-progress-actions');

                    if (inlineActions) {
                        // Clear any existing content
                        inlineActions.innerHTML = '';

                        // Show the container
                        inlineActions.style.display = 'flex';

                        // Add Copy button
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'primary';
                        copyBtn.id = 'copy-output-btn';
                        copyBtn.innerHTML = 'üìã Copy Output to Clipboard';
                        copyBtn.onclick = () => copyOutputToClipboard();
                        inlineActions.appendChild(copyBtn);

                        // Auto-scroll to show button fully (not cut off at bottom)
                        setTimeout(() => {
                            copyBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 100);
                    }
                    break;

                case 'cancelled':
                    progressText.textContent += `\n${event.message}\n`;
                    break;

                case 'error':
                    progressText.textContent += `\nError: ${event.message}\n`;
                    break;
            }

            // Keep scrolled to bottom
            progressText.scrollTop = progressText.scrollHeight;
        }

        async function cancelOperations() {
            if (!confirm('Cancel all running operations?')) {
                return;
            }

            try {
                const response = await fetch('/api/maintenance/cancel', {
                    method: 'POST'
                });

                const result = await response.json();

                const progressText = document.getElementById('progress-text');
                if (progressText) {
                    progressText.textContent += `\n\n‚ö†Ô∏è ${result.message}\n`;
                }

                // Task #123 fix: Hide both Skip and Cancel buttons
                // Also increment invocation ID so old finally blocks don't interfere
                operationInvocationId++;
                runningOperations = false;
                document.getElementById('run-btn').disabled = false;
                document.getElementById('skip-btn').style.display = 'none';
                document.getElementById('cancel-btn').style.display = 'none';

                // Task #131: Stop timers and hide progress
                stopProgressTimer();
                stopQueueStatusPolling();
                document.getElementById('progress-container').style.display = 'none';

                // Task #124: Re-enable Select All/Deselect All buttons
                document.getElementById('select-all-btn').disabled = false;
                document.getElementById('deselect-all-btn').disabled = false;

                console.log('Operations cancelled, incremented invocation ID to', operationInvocationId);

            } catch (error) {
                console.error('Error cancelling operations:', error);
                alert('Error cancelling operations: ' + error.message);
            }
        }

        async function copyOutputToClipboard() {
            const progressText = document.getElementById('progress-text');
            const copyBtn = document.getElementById('copy-output-btn');

            if (!progressText || !copyBtn) return;

            try {
                // Copy text to clipboard
                await navigator.clipboard.writeText(progressText.textContent);

                // Show success feedback
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '‚úì Copied to Clipboard!';
                copyBtn.className = 'primary success-flash';

                // Reset button after 2 seconds
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.className = 'primary';
                }, 2000);

            } catch (error) {
                console.error('Failed to copy to clipboard:', error);

                // Fallback: Show error message
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '‚úó Copy Failed';
                copyBtn.className = 'danger';

                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.className = 'primary';
                }, 2000);
            }
        }

        function getStatusClass(percent) {
            if (percent > 90) return 'danger';
            if (percent > 75) return 'warning';
            return '';
        }

        // Toast notifications
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            }[type] || '‚ÑπÔ∏è';

            toast.innerHTML = `<span style="font-size: 1.5rem;">${icon}</span><span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Quick path functions
        function setPath(path) {
            document.getElementById('path-input').value = path;
            updateBreadcrumbs(path);
            showToast(`Path set to: ${path}`, 'info', 2000);
        }

        function getUsername() {
            // Return stored username from system info, or fallback
            return currentUsername || 'username';
        }

        function updateBreadcrumbs(path) {
            const breadcrumbsDiv = document.getElementById('breadcrumbs');
            if (!breadcrumbsDiv) return;

            const parts = path.split('/').filter(p => p);
            if (parts.length === 0) {
                breadcrumbsDiv.innerHTML = '<span class="breadcrumb" onclick="setPath(\'/\')">Root</span>';
                return;
            }

            let html = '<span class="breadcrumb" onclick="setPath(\'/\')">üè† Root</span>';
            let currentPath = '';

            parts.forEach((part, index) => {
                currentPath += '/' + part;
                const fullPath = currentPath;
                html += ` <span class="breadcrumb-separator">/</span> `;
                html += `<span class="breadcrumb" onclick="setPath('${fullPath}')">${part}</span>`;
            });

            breadcrumbsDiv.innerHTML = html;
        }

        // Operation search and filter
        function filterOperations() {
            const searchTerm = document.getElementById('operation-search').value.toLowerCase();
            const operations = document.querySelectorAll('.operation-item');
            const operationsList = document.getElementById('operations-list');

            let visibleCount = 0;
            operations.forEach(op => {
                const text = op.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    op.style.display = '';
                    visibleCount++;
                } else {
                    op.style.display = 'none';
                }
            });

            // Show empty state if no results
            let existingEmptyState = operationsList.querySelector('.search-empty-state');
            if (visibleCount === 0 && searchTerm) {
                if (!existingEmptyState) {
                    existingEmptyState = document.createElement('div');
                    existingEmptyState.className = 'search-empty-state empty-state';
                    existingEmptyState.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                        <h3>No operations found</h3>
                        <p>Try a different search term or <a href="#" onclick="document.getElementById('operation-search').value=''; filterOperations(); return false;" style="color: var(--accent-color);">clear search</a></p>
                    `;
                    operationsList.appendChild(existingEmptyState);
                }
                existingEmptyState.style.display = 'block';
            } else if (existingEmptyState) {
                existingEmptyState.style.display = 'none';
            }
        }

        function handleSearchKey(event) {
            if (event.key === 'Escape') {
                document.getElementById('operation-search').value = '';
                filterOperations();
            }
        }

        // Quick Start Wizard functions
        // Research-based presets for Mac maintenance (2025-2026 best practices)
        const WIZARD_PRESETS = {
            // Quick Clean: Fast cleanup for weekly/biweekly use (5 min)
            // Research: Browser cache monthly, user caches monthly/quarterly
            quick: ['browser-cache', 'trim-caches'],

            // Weekly Routine: Comprehensive weekly maintenance (15 min)
            // Research: Homebrew weekly, updates weekly, disk verify weekly, caches monthly
            weekly: ['brew-update', 'mas-update', 'disk-verify', 'browser-cache', 'trim-caches', 'trim-logs', 'spotlight-status'],

            // Full Checkup: All recommended + comprehensive safe operations (30 min)
            // Includes: 3 recommended + all safe cleanup + safe diagnostics
            full: ['brew-update', 'mas-update', 'disk-verify', 'browser-cache', 'dev-cache', 'trim-caches', 'trim-logs', 'smart-check', 'spotlight-status', 'dns-flush']
        };

        function showQuickStartWizard() {
            document.getElementById('wizard-modal').classList.add('active');
        }

        function closeWizard() {
            document.getElementById('wizard-modal').classList.remove('active');
        }

        async function selectWizardOption(option) {
            closeWizard();

            if (option === 'custom') {
                showToast('Select operations below', 'info', 2000);
                return;
            }

            // Get operations for this preset (all presets now in WIZARD_PRESETS)
            const operationsToRun = WIZARD_PRESETS[option] || [];

            // Select the operations
            document.querySelectorAll('#operations-list input[type="checkbox"]').forEach(cb => {
                cb.checked = operationsToRun.includes(cb.value);
            });

            // Show confirmation
            const optionNames = {
                quick: 'Quick Clean',
                weekly: 'Weekly Routine',
                full: 'Full Checkup'
            };

            showToast(`‚ú® Selected: ${optionNames[option]} (${operationsToRun.length} operations)`, 'success', 3000);

            // Scroll to operations list
            document.getElementById('operations-list').scrollIntoView({ behavior: 'smooth' });

            // Hide wizard prompt after first use
            const wizardPrompt = document.getElementById('wizard-prompt');
            if (wizardPrompt) {
                wizardPrompt.style.display = 'none';
            }
        }

        // Run Recommended Quick function
        async function runRecommendedQuick() {
            const recommended = allOperations.filter(op => op.recommended);

            if (recommended.length === 0) {
                showToast('No recommended operations available', 'warning');
                return;
            }

            // Build preview message
            const opList = recommended.map(op => `  ‚Ä¢ ${op.name}`).join('\n');
            const message = `Run ${recommended.length} recommended operations?\n\n${opList}\n\nThis will help keep your system clean and optimized.`;

            if (confirm(message)) {
                // Select recommended operations
                recommended.forEach(op => {
                    const checkbox = document.getElementById(`op-${op.id}`);
                    if (checkbox) checkbox.checked = true;
                });

                // Run them
                await runSelectedOperations();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Cmd+Enter or Ctrl+Enter to run selected operations
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                if (document.getElementById('maintenance').classList.contains('active')) {
                    e.preventDefault();
                    runSelectedOperations();
                }
            }

            // Cmd+L or Ctrl+L to focus path input
            if ((e.metaKey || e.ctrlKey) && e.key === 'l') {
                if (document.getElementById('storage').classList.contains('active')) {
                    e.preventDefault();
                    document.getElementById('path-input').focus();
                    document.getElementById('path-input').select();
                }
            }

            // Cmd+F or Ctrl+F to focus search in maintenance tab
            if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
                if (document.getElementById('maintenance').classList.contains('active')) {
                    e.preventDefault();
                    const searchBox = document.getElementById('operation-search');
                    if (searchBox) {
                        searchBox.focus();
                    }
                }
            }
        });

        // ===================================================================
        // SCHEDULE FUNCTIONS
        // ===================================================================

        async function loadScheduleTemplates() {
            try {
                console.log('Loading schedule templates...');
                const response = await fetch('/api/schedules/templates');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Templates loaded:', data);

                const container = document.getElementById('templates-list');
                if (!data.templates || data.templates.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">No templates available</p>';
                    return;
                }

                container.innerHTML = data.templates.map(template => {
                    const templateJson = JSON.stringify(template).replace(/'/g, "\\'");
                    return `
                        <div class="template-card ${template.recommended ? 'recommended' : ''}"
                             onclick='applyTemplate(${templateJson})'>
                            <div class="template-icon">${template.icon}</div>
                            <div class="template-name">${escapeHtml(template.name)}</div>
                            <div class="template-desc">${escapeHtml(template.description)}</div>
                            ${template.recommended ? '<span class="template-badge">RECOMMENDED</span>' : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load templates:', error);
                const container = document.getElementById('templates-list');
                container.innerHTML = `<p style="color: var(--danger);">Error loading templates: ${error.message}</p>`;
                showToast('Failed to load templates: ' + error.message, 'error');
            }
        }

        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules');
                const data = await response.json();

                const container = document.getElementById('schedules-list');

                if (!data.success || !data.schedules || data.schedules.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìÖ</div>
                            <p>No schedules yet</p>
                            <p style="font-size: 0.875rem;">Click "New Schedule" or use a template to get started</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.schedules.map(schedule => {
                    const nextRun = schedule.next_run ? formatDateTime(schedule.next_run) : 'Not scheduled';
                    const lastRun = schedule.last_run ? formatDateTime(schedule.last_run) : 'Never';
                    const statusClass = schedule.enabled ? 'enabled' : 'disabled';
                    const statusText = schedule.enabled ? '‚óè Enabled' : '‚óã Disabled';

                    return `
                        <div class="schedule-card ${schedule.enabled ? '' : 'disabled'}">
                            <div class="schedule-header">
                                <div>
                                    <div class="schedule-title">${escapeHtml(schedule.name)}</div>
                                    ${schedule.description ? `<div class="schedule-desc">${escapeHtml(schedule.description)}</div>` : ''}
                                </div>
                                <div class="schedule-actions">
                                    <button class="secondary" onclick="editSchedule('${schedule.id}')" title="Edit">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="secondary" onclick="toggleScheduleEnabled('${schedule.id}', ${!schedule.enabled})"
                                            title="${schedule.enabled ? 'Disable' : 'Enable'}">
                                        ${schedule.enabled ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                                    </button>
                                    <button class="warning" onclick="runScheduleNow('${schedule.id}')" title="Run now">
                                        ‚ñ∂Ô∏è Run
                                    </button>
                                    <button class="danger" onclick="deleteSchedule('${schedule.id}')" title="Delete schedule">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                            <div class="schedule-info">
                                <div class="schedule-info-item">
                                    <div class="schedule-info-label">Status</div>
                                    <div class="schedule-info-value">
                                        <span class="schedule-status ${statusClass}">${statusText}</span>
                                    </div>
                                </div>
                                <div class="schedule-info-item">
                                    <div class="schedule-info-label">Frequency</div>
                                    <div class="schedule-info-value">${formatFrequency(schedule)}</div>
                                </div>
                                <div class="schedule-info-item">
                                    <div class="schedule-info-label">Time</div>
                                    <div class="schedule-info-value">${schedule.time_of_day}</div>
                                </div>
                                <div class="schedule-info-item">
                                    <div class="schedule-info-label">Next Run</div>
                                    <div class="schedule-info-value">
                                        <span class="next-run-badge">‚è∞ ${nextRun}</span>
                                    </div>
                                </div>
                                <div class="schedule-info-item">
                                    <div class="schedule-info-label">Last Run</div>
                                    <div class="schedule-info-value">${lastRun}</div>
                                </div>
                                <div class="schedule-info-item">
                                    <div class="schedule-info-label">Operations</div>
                                    <div class="schedule-info-value">${schedule.operations.length} selected</div>
                                </div>
                            </div>
                            ${schedule.message ? `
                                <div class="conflict-warning">
                                    <div class="conflict-warning-text">‚ö†Ô∏è ${escapeHtml(schedule.message)}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load schedules:', error);
                showToast('Failed to load schedules', 'error');
            }
        }

        function formatFrequency(schedule) {
            if (schedule.frequency === 'daily') {
                return 'Daily';
            } else if (schedule.frequency === 'weekly') {
                const days = schedule.days_of_week?.map(d => d.substring(0, 3).toUpperCase()).join(', ');
                return `Weekly (${days || 'No days'})`;
            } else if (schedule.frequency === 'monthly') {
                return `Monthly (Day ${schedule.day_of_month})`;
            }
            return schedule.frequency;
        }

        function formatDateTime(isoString) {
            try {
                const date = new Date(isoString);
                const now = new Date();
                const diffMs = date - now;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

                if (diffMs < 0) {
                    return date.toLocaleString();
                } else if (diffDays === 0 && diffHours < 24) {
                    return `in ${diffHours}h`;
                } else if (diffDays < 7) {
                    return `in ${diffDays}d`;
                } else {
                    return date.toLocaleDateString();
                }
            } catch (e) {
                return isoString;
            }
        }

        function showScheduleModal(scheduleId = null) {
            const modal = document.getElementById('schedule-modal');
            const title = document.getElementById('schedule-modal-title');
            const form = document.getElementById('schedule-form');

            form.reset();
            document.getElementById('schedule-id').value = scheduleId || '';
            title.textContent = scheduleId ? 'Edit Schedule' : 'Create Schedule';

            // Load operations into selector
            loadOperationsForSchedule();

            if (scheduleId) {
                loadScheduleForEdit(scheduleId);
            }

            modal.classList.add('active');
        }

        function closeScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            modal.classList.remove('active');
        }

        async function loadOperationsForSchedule() {
            try {
                const response = await fetch('/api/maintenance/operations');
                const data = await response.json();

                const container = document.getElementById('schedule-operations');
                container.innerHTML = data.operations.map(op => `
                    <label class="operation-checkbox">
                        <input type="checkbox" name="operations" value="${op.id}">
                        <div class="operation-checkbox-label">
                            <div class="operation-checkbox-name">${escapeHtml(op.name)}</div>
                            <div class="operation-checkbox-desc">${escapeHtml(op.description || '')}</div>
                        </div>
                    </label>
                `).join('');
            } catch (error) {
                console.error('Failed to load operations:', error);
            }
        }

        async function loadScheduleForEdit(scheduleId) {
            try {
                const response = await fetch(`/api/schedules/${scheduleId}`);
                const data = await response.json();

                if (!data.success) {
                    showToast('Schedule not found', 'error');
                    closeScheduleModal();
                    return;
                }

                const schedule = data.schedule;

                document.getElementById('schedule-name').value = schedule.name || '';
                document.getElementById('schedule-description').value = schedule.description || '';
                document.getElementById('schedule-frequency').value = schedule.frequency;
                document.getElementById('schedule-time').value = schedule.time_of_day.substring(0, 5); // HH:MM
                document.getElementById('schedule-enabled').checked = schedule.enabled;

                // Check selected operations
                schedule.operations.forEach(opId => {
                    const checkbox = document.querySelector(`input[name="operations"][value="${opId}"]`);
                    if (checkbox) checkbox.checked = true;
                });

                // Set frequency-specific fields
                updateFrequencyOptions();

                if (schedule.frequency === 'weekly' && schedule.days_of_week) {
                    schedule.days_of_week.forEach(day => {
                        const checkbox = document.querySelector(`input[name="days"][value="${day}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                if (schedule.frequency === 'monthly' && schedule.day_of_month) {
                    document.getElementById('schedule-day').value = schedule.day_of_month;
                }
            } catch (error) {
                console.error('Failed to load schedule:', error);
                showToast('Failed to load schedule', 'error');
            }
        }

        function updateFrequencyOptions() {
            const frequency = document.getElementById('schedule-frequency').value;
            const daysSelector = document.getElementById('days-selector');
            const daySelector = document.getElementById('day-selector');

            daysSelector.style.display = frequency === 'weekly' ? 'block' : 'none';
            daySelector.style.display = frequency === 'monthly' ? 'block' : 'none';
        }

        async function saveSchedule() {
            const scheduleId = document.getElementById('schedule-id').value;
            const name = document.getElementById('schedule-name').value;
            const description = document.getElementById('schedule-description').value;
            const frequency = document.getElementById('schedule-frequency').value;
            const time = document.getElementById('schedule-time').value;
            const enabled = document.getElementById('schedule-enabled').checked;

            // Get selected operations
            const operations = Array.from(document.querySelectorAll('input[name="operations"]:checked'))
                .map(cb => cb.value);

            if (!name || operations.length === 0 || !time) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const scheduleData = {
                name,
                description,
                operations,
                frequency,
                time_of_day: time + ':00', // Add seconds
                enabled
            };

            // Add frequency-specific fields
            if (frequency === 'weekly') {
                const days = Array.from(document.querySelectorAll('input[name="days"]:checked'))
                    .map(cb => cb.value);
                if (days.length === 0) {
                    showToast('Please select at least one day of the week', 'error');
                    return;
                }
                scheduleData.days_of_week = days;
            } else if (frequency === 'monthly') {
                const day = parseInt(document.getElementById('schedule-day').value);
                if (!day || day < 1 || day > 28) {
                    showToast('Please enter a day between 1 and 28', 'error');
                    return;
                }
                scheduleData.day_of_month = day;
            }

            try {
                const url = scheduleId ? `/api/schedules/${scheduleId}` : '/api/schedules';
                const method = scheduleId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scheduleData)
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to save schedule');
                }

                showToast(scheduleId ? 'Schedule updated!' : 'Schedule created!', 'success');
                closeScheduleModal();
                loadSchedules();
            } catch (error) {
                console.error('Failed to save schedule:', error);
                showToast(error.message, 'error');
            }
        }

        function applyTemplate(template) {
            showScheduleModal();

            // Wait for modal to open and operations to load
            setTimeout(() => {
                document.getElementById('schedule-name').value = template.name;
                document.getElementById('schedule-description').value = template.description;
                document.getElementById('schedule-frequency').value = template.frequency;
                document.getElementById('schedule-time').value = template.time_of_day.substring(0, 5);

                // Check operations
                template.operations.forEach(opId => {
                    const checkbox = document.querySelector(`input[name="operations"][value="${opId}"]`);
                    if (checkbox) checkbox.checked = true;
                });

                // Set frequency options
                updateFrequencyOptions();

                if (template.days_of_week) {
                    template.days_of_week.forEach(day => {
                        const checkbox = document.querySelector(`input[name="days"][value="${day}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                if (template.day_of_month) {
                    document.getElementById('schedule-day').value = template.day_of_month;
                }
            }, 100);
        }

        function editSchedule(scheduleId) {
            showScheduleModal(scheduleId);
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm('Delete this schedule? This will unregister it from launchd.')) {
                return;
            }

            try {
                const response = await fetch(`/api/schedules/${scheduleId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to delete schedule');
                }

                showToast('Schedule deleted', 'success');
                loadSchedules();
            } catch (error) {
                console.error('Failed to delete schedule:', error);
                showToast(error.message, 'error');
            }
        }

        async function toggleScheduleEnabled(scheduleId, enabled) {
            try {
                const response = await fetch(`/api/schedules/${scheduleId}/enabled`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to toggle schedule');
                }

                showToast(enabled ? 'Schedule enabled' : 'Schedule disabled', 'success');
                loadSchedules();
            } catch (error) {
                console.error('Failed to toggle schedule:', error);
                showToast(error.message, 'error');
            }
        }

        async function runScheduleNow(scheduleId) {
            if (!confirm('Run this schedule now? This will execute all operations immediately.')) {
                return;
            }

            try {
                const response = await fetch(`/api/schedules/${scheduleId}/run-now`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to run schedule');
                }

                showToast('Schedule running...', 'success');
                // Reload to show updated last_run
                setTimeout(() => loadSchedules(), 2000);
            } catch (error) {
                console.error('Failed to run schedule:', error);
                showToast(error.message, 'error');
            }
        }

        // Load schedules when Schedule tab is shown
        function onScheduleTabShow() {
            loadScheduleTemplates();
            loadSchedules();
        }

        // Override default alerts with modern toasts
        const originalAlert = window.alert;
        const originalConfirm = window.confirm;

        // ========== Progress Tracking Helper Functions (Task #131) ==========

        function startProgressTimer() {
            // Clear existing timer
            if (progressTimerInterval) {
                clearInterval(progressTimerInterval);
            }

            // Update every second
            progressTimerInterval = setInterval(() => {
                if (operationStartTime > 0) {
                    const elapsed = Date.now() - operationStartTime;
                    document.getElementById('current-op-timer').textContent = formatDuration(elapsed);
                }
            }, 1000);
        }

        function stopProgressTimer() {
            if (progressTimerInterval) {
                clearInterval(progressTimerInterval);
                progressTimerInterval = null;
            }
        }

        function updateProgress() {
            // Update progress bar
            const percent = totalOperations > 0
                ? Math.round((currentOperationIndex / totalOperations) * 100)
                : 0;

            console.log('updateProgress:', {currentOperationIndex, totalOperations, percent});

            const progressBar = document.getElementById('progress-bar');
            const progressPercent = document.getElementById('progress-percent');

            if (progressBar) {
                progressBar.style.width = percent + '%';
                console.log('Set progress-bar width to:', percent + '%');
            } else {
                console.error('progress-bar element not found!');
            }

            if (progressPercent) {
                progressPercent.textContent = percent + '%';
                console.log('Set progress-percent text to:', percent + '%');
            } else {
                console.error('progress-percent element not found!');
            }

            // Update progress label
            document.getElementById('progress-label').textContent =
                `Operation ${currentOperationIndex} of ${totalOperations}`;

            // Update stats
            document.getElementById('ops-progress').textContent =
                `${currentOperationIndex}/${totalOperations}`;

            // Calculate estimated remaining time
            if (operationTimes.length > 0 && currentOperationIndex < totalOperations) {
                const avgTime = operationTimes.reduce((a, b) => a + b, 0) / operationTimes.length;
                const remaining = (totalOperations - currentOperationIndex) * avgTime;
                document.getElementById('est-remaining').textContent = formatDuration(remaining);
            } else if (currentOperationIndex >= totalOperations) {
                document.getElementById('est-remaining').textContent = 'Complete';
            } else {
                document.getElementById('est-remaining').textContent = 'Calculating...';
            }
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            if (seconds < 60) {
                return seconds + 's';
            } else if (seconds < 3600) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}m ${secs}s`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                return `${hours}h ${mins}m`;
            }
        }

        // Queue Status Polling (Task #129)
        function startQueueStatusPolling() {
            // Clear existing interval
            if (queueStatusInterval) {
                clearInterval(queueStatusInterval);
            }

            // Poll every 2 seconds
            queueStatusInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/maintenance/queue');
                    const data = await response.json();

                    // Update queue status if there are waiting operations
                    const queueDiv = document.getElementById('queue-status');
                    if (data.queued_count > 0) {
                        queueDiv.style.display = 'flex';
                        document.getElementById('queue-count').textContent = data.queued_count;
                    } else {
                        queueDiv.style.display = 'none';
                    }

                    // If current operation info available, show it
                    if (data.current_operation) {
                        console.log('Current operation:', data.current_operation);
                    }
                } catch (error) {
                    console.error('Error polling queue status:', error);
                }
            }, 2000);
        }

        function stopQueueStatusPolling() {
            if (queueStatusInterval) {
                clearInterval(queueStatusInterval);
                queueStatusInterval = null;
            }
        }

        // Refresh Last Run Timestamp (Task #130)
        async function refreshLastRunTimestamp() {
            try {
                const response = await fetch('/api/maintenance/last-run');
                const data = await response.json();

                // Update the banner
                const banners = document.querySelectorAll('.last-run-banner');
                banners.forEach(banner => {
                    if (data.last_run) {
                        banner.innerHTML = `üìÖ Last run: ${data.last_run_relative} ${data.status === 'completed' ? '‚úì' : '‚úó'}`;
                    }
                });
            } catch (error) {
                console.error('Error refreshing timestamp:', error);
            }
        }

        // ========== End Progress Tracking Functions ==========

        // Initialize on page load
        initTheme();
        loadSystemInfo();
        loadHealthScore();
        loadTopProcesses();

        // Periodic updates (every 5 seconds)
        setInterval(() => {
            loadSystemInfo();
            loadHealthScore();
            loadTopProcesses();
        }, 5000);
    </script>
</body>
</html>
